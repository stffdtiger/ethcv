<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="jquery-3.3.1.min.js"></script>
    <title>Ethereal Channel Viewer</title>

    <style>
html                { height: 100%; }
body                { height: 100%; margin: 0; background-color: #262626; color: #F1F1F1; font-family: Helvetica, Arial, sans-serif; }
p                   { margin: 0; }
div.page-table      { display: table; height: 100%; }
div.page-cell       { display: table-cell; height: 100%; vertical-align: middle; }
div.divtable        { display: table; }
div.divrow          { display: table-row; }
div.divcell         { display: table-cell; vertical-align: middle; }
div.inline-table    { display: inline-table; }
div.inline-block    { display: inline-block; }
.title              { font-weight: bold; }
.input-text         { width: 125px; }
.input-button       { width: 150px; }
.spanlink           { cursor: pointer; }
#left-bar           { width: 250px; overflow-x: hidden; text-align: center }
#content            { text-align: center; }
#follow-table-helix { width: 100%; }
#follow-table-mixer { width: 100%; }
iframe              { display: block; }
table               { border-collapse: collapse; border: 0px solid red; }
td                  { padding: 0px; }

.selector-section-td         { width: 300px; }
.selector-section-div        { width: inherit; text-align: center; }
.select-button               { background-color: #F1F1F1; color: #262626; padding: 10px; border: 1px solid orange; cursor: pointer; }
.dropdown-content            { display: none; position: absolute; width: inherit; background-color: #262626; color: #F1F1F1; overflow: hidden; z-index: 1; }
.dropdown-content span       { display: block; padding: 6px 0px; cursor: pointer; }
.dropdown-content span:hover { background-color: #F1F1F1; color: #262626; }

.show { display: block; }
    </style>

  </head>
  <body onload="AssignButtons();ChangeResolution('init');">
<!-- PAGE TABLE -->
    <div class="page-table">
<!-- PAGE CELL -->
      <div class="page-cell">
<!-- ALIGNMENT TABLE -->
        <div class="divtable">
<!-- LEFT BAR -->
          <div class="divcell">
            <div class="divtable" id="left-bar">
              <div class="divrow">
                <div class="divcell">
                  <p><span id="reset-form"></span></p>
                </div>
              </div>
              <div class="divrow">
                <div class="divcell">
                  <p class="title"><span class="spanlink" title="click to update twitch list" onclick="UpdateFollowListHelix()">[twitch]</span></p>
                  <div id="follows-helix"></div>
                  <p class="title"><span class="spanlink" title="click to update mixer list" onclick="UpdateFollowListMixer()">[mixer]</span></p>
                  <div id="follows-mixer"></div>
                </div>
              </div>
            </div>
          </div>
<!-- CONTENT -->
          <div class="divcell">
            <table id="content">
              <tr>
                <td colspan="2">
                  <table style="display: inline-table;">
                    <tr>
                      <td class="selector-section-td">
                        <div class="selector-section-div">
                          <button class="select-button" onclick="ToggleDropdown('resoDropdown')">Player/Chat Dimensions</button>
                          <div class="dropdown-content" id="resoDropdown">
                            <span class="spanlink" onclick="ChangeResolution('360p')">360p</span>
                            <span class="spanlink" onclick="ChangeResolution('480p')">480p</span>
                            <span class="spanlink" onclick="ChangeResolution('720p')">720p</span>
                          </div>
                        </div>
                      </td>
                      <td class="selector-section-td">
                        <div class="selector-section-div">
                          <button class="select-button" id="current-user" onclick="ToggleDropdown('userDropdown')">User</button>
                          <div class="dropdown-content" id="userDropdown">
                            <span><input class="input-text" id="input-user" type="text" /><input class="input-button" id="button-user" type="button" value="Load User" onclick="LoadUser(document.getElementById('input-user').value)" /></span>
                          </div>
                        </div>
                      </td>
                      <td class="selector-section-td">
                        <div class="selector-section-div">
                          <button class="select-button" id="current-channel" onclick="ToggleDropdown('channelDropdown')">Channel</button>
                          <div class="dropdown-content" id="channelDropdown">
                            <span><input class="input-text" id="input-channel-twitch" type="text" /><input class="input-button" id="button-channel-twitch" type="button" value="Load Twitch Channel" onclick="LoadChannel(document.getElementById('input-channel-twitch').value, 'twitch')" /></span>
                            <span><input class="input-text" id="input-channel-mixer" type="text" /><input class="input-button" id="button-channel-mixer" type="button" value="Load Mixer Channel" onclick="LoadChannel(document.getElementById('input-channel-mixer').value, 'mixer')" /></span>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
              <tr>
                <td style="background-color: #F1F1F1; color: #262626;">
                  <iframe id="frame-player" src="about:blank" frameborder="0" allowfullscreen="true" scrolling="no" width="16" height="9"></iframe>
                </td>
                <td style="background-color: #F1F1F1;">
                  <iframe id="frame-chat" src="about:blank" frameborder="0" scrolling="no" width="340" height="9"></iframe>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
var g_userName;
var isFirstId;
var oldTableT, oldTableM;
var countHelix, countMixer;
var pageHelix, pageMixer;
var urlUsersTwitch, urlStreamsTwitch;
var dataUserTwitch, dataFollowsTwitch, dataUsersTwitch, dataStreamsTwitch;
var dataUserMixer, dataFollowsMixer;
var userObjT = {};
var userIndexTwitch, userIndexMixer;
var hasCountTwitch, hasCountMixer;
var tableT, rowT, cellT, pT, spanT;
var tableM, rowM, cellM, pM, spanM;
var ii, jj;
//var reset;

function AssignButtons() {
  var element;
  element = document.getElementById("input-channel-twitch");
  element.addEventListener("keyup", function(event) {
    event.preventDefault();
    if (event.keyCode == 13) {
      document.getElementById("button-channel-twitch").click();
    }
  });
  element = document.getElementById("input-channel-mixer");
  element.addEventListener("keyup", function(event) {
    event.preventDefault();
    if (event.keyCode == 13) {
      document.getElementById("button-channel-mixer").click();
    }
  });
  element = document.getElementById("input-user");
  element.addEventListener("keyup", function(event) {
    event.preventDefault();
    if (event.keyCode == 13) {
      document.getElementById("button-user").click();
    }
  });
}

function ToggleDropdown(selector) {
  document.getElementById(selector).classList.toggle("show");
}

function ChangeResolution(newReso) {
  if (resoDropdown.classList.contains('show')) {
    resoDropdown.classList.remove('show');
  }
  var date = new Date();
  date.setTime(date.getTime()+(30*24*60*60*1000));
  var expires = "; expires="+date.toGMTString();

  if (newReso == "init") {
    var cname = "reso=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for (var ii = 0 ; ii < ca.length ; ii++) {
      var c = ca[ii];
      while (c.charAt(0) == ' ') {
        c = c.substring(1);
      }
      if (c.indexOf(cname) == 0) {
        return ChangeResolution(c.substring(cname.length, c.length));
      }
    }
    return ChangeResolution("360p");
  } else {
    if (newReso == "720p" && document.getElementById("frame-player").height != "720") {
      document.getElementById("frame-player").setAttribute("width", "1280");
      document.getElementById("frame-player").setAttribute("height", "720");
      document.getElementById("frame-chat").setAttribute("height", "720");
      document.cookie = "reso=720p" + expires + "; path=/";
    } else if (newReso == "480p" && document.getElementById("frame-player").height != "480") {
      document.getElementById("frame-player").setAttribute("width", "852");
      document.getElementById("frame-player").setAttribute("height", "480");
      document.getElementById("frame-chat").setAttribute("height", "480");
      document.cookie = "reso=480p" + expires + "; path=/";
    } else if (newReso == "360p" && document.getElementById("frame-player").height != "360") {
      document.getElementById("frame-player").setAttribute("width", "640");
      document.getElementById("frame-player").setAttribute("height", "360");
      document.getElementById("frame-chat").setAttribute("height", "360");
      document.cookie = "reso=360p" + expires + "; path=/";
    }
  }
}

function LoadChannel(channelName, service) {
  if (channelDropdown.classList.contains('show')) {
    channelDropdown.classList.remove('show');
  }
  if (channelName == "") {
    document.getElementById("current-channel").innerHTML = "No Channel Loaded";
    document.getElementById("frame-player").setAttribute("src", "about:blank");
    document.getElementById("frame-chat").setAttribute("src", "about:blank");
  } else {
    document.getElementById("current-channel").innerHTML = channelName;
    if (service == "twitch") {
      document.getElementById("frame-player").setAttribute("src", "https://player.twitch.tv/?channel="+channelName);
      document.getElementById("frame-chat").setAttribute("src", "https://www.twitch.tv/embed/"+channelName+"/chat");
      document.getElementById("frame-chat").setAttribute("width", "340");
    } else {
      document.getElementById("frame-player").setAttribute("src", "https://mixer.com/embed/player/"+channelName);
      document.getElementById("frame-chat").setAttribute("src", "https://mixer.com/embed/chat/"+channelName);
      document.getElementById("frame-chat").setAttribute("width", "350");
    }
  }
}

function LoadUser(userName) {
  if (userDropdown.classList.contains('show')) {
    userDropdown.classList.remove('show');
  }
  if (userName == "") {
    document.getElementById("current-user").innerHTML = "No User Loaded";
    oldTableT = document.getElementById("follow-table-helix");
    if (oldTableT) oldTableT.parentNode.removeChild(oldTableT);
    oldTableM = document.getElementById("follow-table-mixer");
    if (oldTableM) oldTableM.parentNode.removeChild(oldTableM);
  } else {
    document.getElementById("current-user").innerHTML = userName;
    oldTableT = document.getElementById("follow-table-helix");
    if (oldTableT) oldTableT.parentNode.removeChild(oldTableT);
    oldTableM = document.getElementById("follow-table-mixer");
    if (oldTableM) oldTableM.parentNode.removeChild(oldTableM);
    g_userName = userName;
    CreateFollowListHelix();
    CreateFollowListMixer();
  }
}

function CreateFollowListHelix() {
  $.ajax({
    type: "GET",
    url: "https://api.twitch.tv/helix/users?login=" + g_userName,
    headers: { "Client-ID": "88pfy9ckfkxt3mp678i4ar9b0tr2q6" },
    success: function(data, status, jqxhr) {
      //console.log(data);
      dataUserTwitch = data;
      //reset = parseInt(jqxhr.getResponseHeader("Ratelimit-Remaining"));
      //alert(reset);
    },
    complete: function(jqxhr, status) {
      if (status == "success") {
        GetFollowsHelix(true, false);
      }
    }
  });
}

function GetFollowsHelix(init, destroy) {
  if (init) {
    userIndexTwitch = 0;
    hasCountTwitch = false;
    pageHelix = "";
    if (!destroy) {
      tableT = document.createElement("div");
      tableT.classList.add("divtable");
      tableT.setAttribute("id", "follow-table-helix");
      document.getElementById("follows-helix").appendChild(tableT);
    }
  }

  if (destroy) {
    oldTableT = document.getElementById("follow-table-helix");
    if (oldTableT) oldTableT.parentNode.removeChild(oldTableT);
    tableT = document.createElement("div");
    tableT.classList.add("divtable");
    tableT.setAttribute("id", "follow-table-helix");
    document.getElementById("follows-helix").appendChild(tableT);
  }

  $.ajax({
    type: "GET",
    url: "https://api.twitch.tv/helix/users/follows?from_id=" + dataUserTwitch.data[0].id + "&first=100&after=" + pageHelix,
    headers: { "Client-ID": "88pfy9ckfkxt3mp678i4ar9b0tr2q6" },
    success: function(data, status, jqxhr) {
      //console.log(data);
      dataFollowsTwitch = data;
      //reset = parseInt(jqxhr.getResponseHeader("Ratelimit-Remaining"));
      if (!hasCountTwitch) {
        countHelix = parseInt(dataFollowsTwitch.total);
        countHelix -= dataFollowsTwitch.data.length;
        hasCountTwitch = true;
      } else {
        countHelix -= dataFollowsTwitch.data.length;
      }
      pageHelix = dataFollowsTwitch.pagination.cursor;
      isFirstId = true;
      urlUsersTwitch = "https://api.twitch.tv/helix/users";
      urlStreamsTwitch = "https://api.twitch.tv/helix/streams";
      for (ii = 0 ; ii < dataFollowsTwitch.data.length ; ii++) {
        if (isFirstId) { // with first id add ? instead of &
          urlUsersTwitch = urlUsersTwitch + "?id=" + dataFollowsTwitch.data[ii].to_id;
          urlStreamsTwitch = urlStreamsTwitch + "?user_id=" + dataFollowsTwitch.data[ii].to_id;
          isFirstId = false;
        } else {
          urlUsersTwitch = urlUsersTwitch + "&id=" + dataFollowsTwitch.data[ii].to_id;
          urlStreamsTwitch = urlStreamsTwitch + "&user_id=" + dataFollowsTwitch.data[ii].to_id;
        }
      }
    },
    complete: function(jqxhr, status) {
      if (status == "success") {
        return GetUsersHelix();
      }
    }
  });
}

function GetUsersHelix() {
  $.ajax({
    type: "GET",
    url: urlUsersTwitch,
    headers: { "Client-ID": "88pfy9ckfkxt3mp678i4ar9b0tr2q6" },
    success: function(data, status, jqxhr) {
      //console.log(data);
      dataUsersTwitch = data;
      //reset = parseInt(jqxhr.getResponseHeader("Ratelimit-Remaining"));
      userObjT.user = [];
      for (ii = 0 ; ii < dataUsersTwitch.data.length ; ii++) {
        userObjT.user[dataUsersTwitch.data[ii].login] = { id: dataUsersTwitch.data[ii].id, viewers: "", live: "", title: "" };
      }
    },
    complete: function(jqxhr, status) {
      if (status == "success") {
        return GetStreamsHelix();
      }
    }
  });
}

function GetStreamsHelix() {
  $.ajax({
    type: "GET",
    url: urlStreamsTwitch,
    headers: { "Client-ID": "88pfy9ckfkxt3mp678i4ar9b0tr2q6" },
    success: function(data, status, jqxhr) {
      //console.log(data);
      dataStreamsTwitch = data;
      //reset = parseInt(jqxhr.getResponseHeader("Ratelimit-Remaining"));
      for (ii = 0 ; ii < dataUsersTwitch.data.length ; ii++) {
        for (jj = 0 ; jj < dataStreamsTwitch.data.length ; jj++) {
          if (userObjT.user[dataUsersTwitch.data[ii].login].id == dataStreamsTwitch.data[jj].user_id) {
            userObjT.user[dataUsersTwitch.data[ii].login].viewers = dataStreamsTwitch.data[jj].viewer_count;
            userObjT.user[dataUsersTwitch.data[ii].login].live = dataStreamsTwitch.data[jj].type;
            userObjT.user[dataUsersTwitch.data[ii].login].title = dataStreamsTwitch.data[jj].title;
          }
        }
      }
    },
    complete: function(jqxhr, status) {
      if (status == "success" ) {
        $.when(AfterGetsHelix()).done( function() {
          if (countHelix > 0 && userIndexTwitch < 20) {
            return GetFollowsHelix(false, false);
          }
        });
      }
    }
  });
}

function AfterGetsHelix() {
  for (ii = 0 ; ii < dataUsersTwitch.data.length ; ii++) {
    if (userObjT.user[dataUsersTwitch.data[ii].login].live == "live" && userIndexTwitch < 20) {
      rowT = document.createElement("div");
      rowT.classList.add("divrow");
      tableT.appendChild(rowT);
      cellT = document.createElement("div");
      cellT.classList.add("divcell");
      rowT.appendChild(cellT);
      pT = document.createElement("p");
      cellT.appendChild(pT);
      spanT = document.createElement("span");
      spanT.classList.add("spanlink");
      spanT.setAttribute("id", "helix" + userIndexTwitch); // set element ID
      pT.appendChild(spanT);
      spanT.index = dataUsersTwitch.data[ii].login;
      spanT.innerHTML = dataUsersTwitch.data[ii].login + " (" + userObjT.user[dataUsersTwitch.data[ii].login].viewers + " viewers)"; // display names from twitch IDs
      spanT.title = userObjT.user[dataUsersTwitch.data[ii].login].title;
      spanT.onclick = function(event) { LoadChannel(event.target.index, "twitch") }; // create links for fast channel changes
      userIndexTwitch++;
    }
  }
}

function UpdateFollowListHelix() {
  return GetFollowsHelix(true, true);
}

function CreateFollowListMixer() {
  $.ajax({
    type: "GET",
    url: "https://mixer.com/api/v1/channels/" + g_userName,
    headers: { "Client-ID": "07b3b0eaa709e93934f6720d6130f2aa0ec716a93c5033d6" },
    success: function(data, status, jqxhr) {
      //console.log(data);
      dataUserMixer = data;
    },
    complete: function(jqxhr, status) {
      if (status == "success") {
        GetFollowsMixer(true, false);
      }
    }
  });
}

function GetFollowsMixer(init, destroy) {
  if (init) {
    userIndexMixer = 0;
    hasCountMixer = false;
    pageMixer = 0;
    if (!destroy) {
      tableM = document.createElement("div");
      tableM.classList.add("divtable");
      tableM.setAttribute("id", "follow-table-mixer");
      document.getElementById("follows-mixer").appendChild(tableM);
    }
  }

  if (destroy) {
    oldTableM = document.getElementById("follow-table-mixer");
    if (oldTableM) oldTableM.parentNode.removeChild(oldTableM);
    tableM = document.createElement("div");
    tableM.classList.add("divtable");
    tableM.setAttribute("id", "follow-table-mixer");
    document.getElementById("follows-mixer").appendChild(tableM);
  }

  $.ajax({
    type: "GET",
    url: "https://mixer.com/api/v1/users/" + dataUserMixer.user.id + "/follows?limit=100&page=" + pageMixer,
    headers: { "Client-ID": "07b3b0eaa709e93934f6720d6130f2aa0ec716a93c5033d6" },
    success: function(data, status, jqxhr) {
      //console.log(data);
      dataFollowsMixer = data;

      if (!hasCountMixer) {
        countMixer = jqxhr.getResponseHeader("x-total-count");
        countMixer -= dataFollowsMixer.length;
        hasCountMixer = true;
      } else {
        countMixer -= dataFollowsMixer.length;
      }

      pageMixer++;

      for (ii = 0 ; ii < dataFollowsMixer.length ; ii++) {
        if (dataFollowsMixer[ii].online == true) {
          rowM = document.createElement("div");
          rowM.classList.add("divrow");
          tableM.appendChild(rowM);
          cellM = document.createElement("div");
          cellM.classList.add("divcell");
          rowM.appendChild(cellM);
          pM = document.createElement("p");
          cellM.appendChild(pM);
          spanM = document.createElement("span");
          spanM.classList.add("spanlink");
          pM.appendChild(spanM);
          spanM.index = dataFollowsMixer[ii].token;
          spanM.innerHTML = dataFollowsMixer[ii].token + " (" + dataFollowsMixer[ii].viewersCurrent + " viewers)"; // display names from mixer IDs
          spanM.title = dataFollowsMixer[ii].name;
          spanM.onclick = function(event) { LoadChannel(event.target.index, "mixer") }; // create links for fast channel changes
          userIndexMixer++;
        }
      }
    },
    complete: function(jqxhr, status) {
      if (status == "success") {
        if (countMixer > 0 && userIndexMixer < 20) {
          return GetFollowsMixer(false, false);
        }
      }
    }
  });
}

function UpdateFollowListMixer() {
  GetFollowsMixer(true, true);
}


/*
window.onclick = function(event) {
  if (!event.target.matches('.resoButton')) {
    var resoDropdown = document.getElementById("resoDropdown");
    if (resoDropdown.classList.contains('show')) {
        resoDropdown.classList.remove('show');
    }
  }
}
*/

/*
function UpdateResetForm() {
  if (reset) {
    if (document.getElementById("reset-form").innerHTML !== reset) {
      document.getElementById("reset-form").innerHTML = reset;
    }
  } else if (document.getElementById("reset-form").innerHTML != "broken") {
    document.getElementById("reset-form").innerHTML = "broken";
  }
}

var x = setInterval(UpdateResetForm(), 1000);
*/

    </script>

  </body>
</html>